name: CD

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  IDF_VERSION: v5.3.2
  IDF_TARGET: esp32p4

jobs:
  release-firmware:
    name: Build ${{ matrix.app.name }} and publish artifacts
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app:
          - name: FIRST_TEST
            path: FIRST_TEST
            target: esp32p4
          - name: ReceiveTest
            path: ReceiveTest
            target: esp32p4
          - name: SCREEN_TEST
            path: SCREEN_TEST/SCREEN_TEST
            target: esp32p4

    defaults:
      run:
        shell: bash
        working-directory: ${{ matrix.app.path }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ESP-IDF host dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git wget flex bison gperf cmake ninja-build ccache \
            libffi-dev libssl-dev dfu-util libusb-1.0-0

      - name: Cache ESP-IDF and tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.espressif
            ~/esp-idf
          key: ${{ runner.os }}-espidf-${{ env.IDF_VERSION }}-${{ matrix.app.target }}

      - name: Install ESP-IDF
        run: |
          if [ ! -d "$HOME/esp-idf" ]; then
            git clone --depth 1 --branch "$IDF_VERSION" https://github.com/espressif/esp-idf.git "$HOME/esp-idf"
          fi
          "$HOME/esp-idf/install.sh" "${{ matrix.app.target }}"

      - name: Build release firmware
        run: |
          . "$HOME/esp-idf/export.sh"
          idf.py set-target ${{ matrix.app.target }}
          idf.py build

      - name: Package firmware artifacts
        run: |
          mkdir -p dist/${{ matrix.app.name }}
          cp build/*.bin dist/${{ matrix.app.name }}/
          cp build/*.elf dist/${{ matrix.app.name }}/
          cp build/*.map dist/${{ matrix.app.name }}/
          cp build/bootloader/*.bin dist/${{ matrix.app.name }}/
          cp build/partition_table/*.bin dist/${{ matrix.app.name }}/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app.name }}-release-${{ github.ref_name }}
          path: ${{ matrix.app.path }}/dist/${{ matrix.app.name }}/*
          if-no-files-found: error

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.app.path }}/dist/${{ matrix.app.name }}/*
          generate_release_notes: true
